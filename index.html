<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        .main {
            margin: 3em;
        }

        .heading {
            padding: 1em;
            background-color: #E2DAD4;
        }

        p {
            font-size: 1.1em;
            font-family: 'Roboto Condensed', sans-serif;
            color: #89192D;
            visibility: hidden;
        }

        h1 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 400;
        }

        h2 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 40;
            color: #89192D;
        }

        h3 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 35;
            margin-bottom: 2px;
            color: black;
        }

        h4 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 300;
            font-size: 20;
            margin-top: 2px;
            margin-bottom: 0;
            color: #A5A5A5;
        }

        .gridlines .domain {
            display: none;
        }

        .gridlines line {
            stroke: #bbb;
        }

        .food,
        .wine {
            padding-top: 10px;
            padding-bottom: 10px;
            border: 2px solid white;
        }

        .food:hover,
        .wine:hover {
            border: 2px solid #D17076 !important;
            cursor: pointer;
        }

        .btn-main {
            text-align: right;
            margin-right: 5%;
            margin-top: 5px;
        }

        .button {
            border: none;
            background-color: #8F8F8F;
            color: white;
            padding-left: 25px;
            padding-right: 25px;
            padding-top: 10px;
            padding-bottom: 10px;
            text-align: center;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 25px;
            cursor: pointer;
            border-radius: 25px;
            box-shadow: 0px 4px 4px 0px #C1C1C1;
        }

        .country {
            fill: lightgrey;
        }

        .border {
            stroke: rgb(255, 255, 255);
            stroke-width: 1px;
            fill: none;
        }
    </style>

</head>

<body>
    <div class="main">
        <div class="heading">
            <h1 style="text-align: center;">Project 3</h1>
            <h2 style="text-align: center;">Find the Perfect Bottle of Wine to Pair with Any Meal!</h2>
        </div>
        <div id="step-1" style="display: block;">
            <h3>01 | What are you eating? </h3>
            <h4>Select a food group below</h4>
            <table style="width: 100%; text-align: center;">
                <tr>
                    <td class="food" id="Vegetables" onclick="selectFood(`Vegetables`)"><img
                            src="/Assets/Vegetables.png" width="120px"><br />
                        <h4>Vegetables</h4>
                    </td>
                    <td class="food" id="SoftCheese" onclick="selectFood(`SoftCheese`)"><img
                            src="/Assets/Soft Cheese.png" width="120px"><br />
                        <h4>Soft Cheese</h4>
                    </td>
                    <td class="food" id="HardCheese" onclick="selectFood(`HardCheese`)"><img
                            src="/Assets/Hard Cheese.png" width="120px"><br />
                        <h4>Hard Cheese</h4>
                    </td>
                    <td class="food" id="Starches" onclick="selectFood(`Starches`)"><img src="/Assets/Starches.png"
                            width="120px"><br />
                        <h4>Starches</h4>
                    </td>
                    <td class="food" id="Fish" onclick="selectFood(`Fish`)"><img src="/Assets/Fish.png"
                            width="120px"><br />
                        <h4>Fish</h4>
                    </td>
                </tr>
                <br />
                <tr>
                    <td class="food" id="Shellfish" onclick="selectFood(`Shellfish`)"><img src="/Assets/Shellfish.png"
                            width="120px"><br />
                        <h4>Shellfish</h4>
                    </td>
                    <td class="food" id="WhiteMeat" onclick="selectFood(`WhiteMeat`)"><img src="/Assets/White Meat.png"
                            width="120px"><br />
                        <h4>White Meat</h4>
                    </td>
                    <td class="food" id="RedMeat" onclick="selectFood(`RedMeat`)"><img src="/Assets/Red Meat.png"
                            width="120px"><br />
                        <h4>Red Meat</h4>
                    </td>
                    <td class="food" id="CuredMeat" onclick="selectFood(`CuredMeat`)"><img src="/Assets/Cured Meat.png"
                            width="120px"><br />
                        <h4>Cured Meat</h4>
                    </td>
                    <td class="food" id="Dessert" onclick="selectFood(`Dessert`)"><img src="/Assets/Dessert.png"
                            width="120px"><br />
                        <h4>Dessert</h4>
                    </td>
                </tr>
            </table>
            <div class="btn-main">
                <p id="error-1">** Please select atleast one food to proceed **</p>
                <button class="button" onclick="clickedButton(1)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-2" style="display: none;">
            <h3>02 | What type of wine do you prefer? </h3>
            <h4 id="step2-label"></h4>
            <br />
            <table style="width: 100%; text-align: center;">
                <tr class="wineBottles">
                </tr>
            </table>
            <div class="btn-main">
                <p id="error-2">** Please select atleast one wine to proceed **</p>
                <button class="button" onclick="clickedButton(2)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-3" style="display: none;">
            <h3>03 | Which country's wine do you prefer? </h3>
            <div>
                <svg id="world-map" width="1000" height="600" style="border: 1px solid black;"></svg>
            </div>
            <div class="btn-main">
                <p id="error-3">** Please select atleast one country to proceed **</p>
                <button class="button" onclick="clickedButton(3)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-4" style="display: none;">
            <h3>04 | What is your price point? </h3>
            <svg id="chart" height="800" width="800"></svg>
            <div class="btn-main">
                <p id="error-4">** Please indicate a price range to proceed **</p>
                <button class="button" onclick="clickedButton(4)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-5" style="display: none;">
            <h3>05 | Which bottle catches your eye? </h3>
            <div class="btn-main">
                <p id="error-5">** Please select a bottle to proceed **</p>
                <button class="button" onclick="clickedButton(5)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-6" style="display: none;">
            <h3>Here's your wine, enjoy!</h3>
            <div class="btn-main">
                <button class="button" onclick="clickedButton(6)">Retake Quiz</button>
            </div>
        </div>
    </div>
    <script>
        // Mapping food names without and with space
        const readableFoodNames = {
            "Vegetables": "Vegetables",
            "SoftCheese": "Soft Cheese",
            "HardCheese": "Hard Cheese",
            "Starches": "Starches",
            "Fish": "Fish",
            "Shellfish": "Shellfish",
            "WhiteMeat": "White Meat",
            "RedMeat": "Red Meat",
            "CuredMeat": "Cured Meat",
            "Dessert": "Dessert"
        }

        // Pairing of foods and wines
        const foodGroups = {
            "Vegetables": ["Red", "Rose", "White", "Sparkling"],
            "SoftCheese": ["Rose", "White", "Sparkling"],
            "HardCheese": ["Red", "White", "Sparkling"],
            "Starches": ["Red", "Rose", "White", "Sparkling"],
            "Fish": ["White", "Sparkling"],
            "Shellfish": ["Red", "Rose", "White"],
            "WhiteMeat": ["Red", "White"],
            "RedMeat": ["Red"],
            "CuredMeat": ["Red", "White"],
            "Dessert": ["White"]
        }

        var redCountriesTop10;
        var whiteCountriesTop10;
        var roseCountriesTop10;
        var sparklingCountriesTop10;

        const requestData = async function () {
            let redWines = await d3.csv("Red.csv", d3.autoType);
            let whiteWines = await d3.csv("White.csv", d3.autoType);
            let roseWines = await d3.csv("Rose.csv", d3.autoType);
            let sparklingWines = await d3.csv("Sparkling.csv", d3.autoType);

            /* DATA PROCESSING:
             * For each wine category: Count the number of rows for a country
             * Keep only the data that belongs to one of the top 10 countries
             * 
             * Change price from EUR to USD
             */

            // ===== DATA PROCESSING FOR RED WINES =====
            redCountryCount = {};
            // counting number of wines from each country
            redWines.forEach(item => {
                if (item['Country'] in redCountryCount) {
                    redCountryCount[item['Country']] += 1;
                } else {
                    redCountryCount[item['Country']] = 1;
                }
            });
            let redCountries = Object.entries(redCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (redCountries.length > 10) {
                redCountries.splice(10); // keeping only the top 10 countries
            }

            // save the top 10 countries with the count for red wine
            redCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                redCountriesTop10.set(redCountries[i], redCountryCount[redCountries[i]]);
            }
            // delete entries from other countries
            redWines.forEach((item, index) => {
                if (!redCountries.includes(item["Country"])) {
                    redWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });

            // ===== DATA PROCESSING FOR WHITE WINES =====
            whiteCountryCount = {};
            // counting number of wines from each country
            whiteWines.forEach(item => {
                if (item['Country'] in whiteCountryCount) {
                    whiteCountryCount[item['Country']] += 1;
                } else {
                    whiteCountryCount[item['Country']] = 1;
                }
            });
            let whiteCountries = Object.entries(whiteCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (whiteCountries.length > 10) {
                whiteCountries.splice(10); // keeping only the top 10 countries
            }
            // save the top 10 countries with the count for white wine
            whiteCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                whiteCountriesTop10.set(whiteCountries[i], whiteCountryCount[whiteCountries[i]]);
            }

            // delete entries from other countries
            whiteWines.forEach((item, index) => {
                if (!whiteCountries.includes(item["Country"])) {
                    whiteWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });

            // ===== DATA PROCESSING FOR ROSE WINES =====
            roseCountryCount = {};
            // counting number of wines from each country
            roseWines.forEach(item => {
                if (item['Country'] in roseCountryCount) {
                    roseCountryCount[item['Country']] += 1;
                } else {
                    roseCountryCount[item['Country']] = 1;
                }
            });
            let roseCountries = Object.entries(roseCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (roseCountries.length > 10) {
                roseCountries.splice(10); // keeping only the top 10 countries
            }
            // save the top 10 countries with the count for rose wine
            roseCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                roseCountriesTop10.set(roseCountries[i], roseCountryCount[roseCountries[i]]);
            }
            // delete entries from other countries
            roseWines.forEach((item, index) => {
                if (!roseCountries.includes(item["Country"])) {
                    roseWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });

            // ===== DATA PROCESSING FOR SPARKLING WINES =====
            sparklingCountryCount = {};
            // counting number of wines from each country
            sparklingWines.forEach(item => {
                if (item['Country'] in sparklingCountryCount) {
                    sparklingCountryCount[item['Country']] += 1;
                } else {
                    sparklingCountryCount[item['Country']] = 1;
                }
            });
            let sparklingCountries = Object.entries(sparklingCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (sparklingCountries.length > 10) {
                sparklingCountries.splice(10); // keeping only the top 10 countries
            }
            // save the top 10 countries with the count for sparkling wine
            sparklingCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                sparklingCountriesTop10.set(sparklingCountries[i], sparklingCountryCount[sparklingCountries[i]]);
            }

            // delete entries from other countries
            sparklingWines.forEach((item, index) => {
                if (!sparklingCountries.includes(item["Country"])) {
                    sparklingWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });
        };

        // --- TRACKING USER SELECTIONS ---
        let selectedFoodItem;
        let selectedWine;
        let selectedCountry;

        // Step 1: Selecting food item
        function selectFood(foodItem) {
            let allFoods = d3.selectAll("td");
            allFoods.style("border", "2px solid white");
            const currSelection = "td#" + foodItem;
            let currFoodItem = d3.select(currSelection);
            currFoodItem.style("border", "2px solid black");
            selectedFoodItem = foodItem;
        }

        // Step 1 to Step 2 filtering
        function findFoodPairing() {
            let label = d3.select("#step2-label");
            const availableWines = foodGroups[selectedFoodItem];
            let textString = "";
            let tableRow = d3.select(".wineBottles");
            for (let i = 0; i < availableWines.length; i++) {
                // Displaying the correct wines
                let wine = tableRow.append("td")
                    .attr("class", "wine")
                    .attr("id", availableWines[i]);
                let currImgLocation = "/Assets/" + availableWines[i] + ".png";
                wine.append("img") // Wine images
                    .attr("height", 300)
                    .attr("src", currImgLocation);
                wine.on("click", function () { // Interactivity on selecting wine
                    let allWines = d3.selectAll("td");
                    allWines.style("border", "2px solid white"); // Unselect other selections
                    const currSelection = "td#" + availableWines[i];
                    let currWine = d3.select(currSelection);
                    currWine.style("border", "2px solid black");
                    selectedWine = availableWines[i];
                });

                // Setting the description header text
                textString = textString + availableWines[i];
                if (i != availableWines.length - 1) {
                    textString = textString + ","; // add comma after all but the last name
                }
                textString = textString + " ";
            }
            textString = textString + "wine(s) pair best with " + readableFoodNames[selectedFoodItem];
            if (availableWines.length > 1) {
                textString = textString + ". Pick One!";
            } else {
                textString = textString + ". Please select it to proceed!";
            }
            label.text(textString);
        }

        // Step 2 to Step 3 filtering
        function findWineCountry() {
            // TODO
            let top10Countries;
            if (selectedWine == "Red") {
                top10Countries = redCountriesTop10;
            } else if (selectedWine == "Rose") {
                top10Countries = roseCountriesTop10;
            } else if (selectedWine == "White") {
                top10Countries = whiteCountriesTop10;
            } else if (selectedWine == "Sparkling") {
                top10Countries = sparklingCountriesTop10;
            }
            drawMapChart(top10Countries);
        }

        // draw the map
        const drawMapChart = async function (top10Countries) {
            let worldMap = d3.select('#world-map');
            let width = worldMap.attr('width');
            let height = worldMap.attr('height');
            let padding = { top: 20, right: 20, bottom: 20, left: 20 };
            let mapWidth = width - padding.left - padding.right;
            let mapHeight = height - padding.top - padding.bottom;
            // color scale
            let colorScale = d3.scaleQuantile()
                .domain([0, 2650])
                .range(['#44A8DE', '#3260AF', '#22297F', '#1F134D']);

            // map data
            let world = await d3.json('geography.json');
            let countries = topojson.feature(world, world.objects.countries);
            let countriesMesh = topojson.mesh(world, world.objects.countries);
            let projection = d3.geoMercator().fitSize([mapWidth, mapHeight], countries);
            let path = d3.geoPath().projection(projection);

            // draw map
            let map = worldMap.append("g")
                .attr('transform', `translate(${padding.left}, ${padding.top})`);

            map.selectAll('path.state')
                .data(countries.features)
                .join('path')
                .attr('class', 'country')
                .attr('id', d => d.properties.name)
                .attr('d', path)
                .style('fill', d => {
                    if (top10Countries.has(d.properties.name)) {
                        return colorScale(top10Countries.get(d.properties.name));
                    } else {
                        return "lightgrey";
                    }
                })
                .on("click", function () {
                    let country = d3.select(this).datum().properties.name;
                    if (top10Countries.has(country)) {
                        selectedCountry = country;
                        alert(country + " is Selected");
                    }
                });
            map.append('path')
                .datum(countriesMesh)
                .attr('class', 'border')
                .attr('d', path);
        };

        // Button transition from one question to the next
        function clickedButton(stepNum) {
            // Error conditions for moving to "next"
            const errorString = "#error-" + stepNum;
            let errorMessage = d3.select(errorString);
            if (stepNum == 1 && selectedFoodItem == undefined) {
                errorMessage.style("visibility", "visible");
            } else if (stepNum == 2 && selectedWine == undefined) {
                errorMessage.style("visibility", "visible");
            } else if (stepNum == 3 && selectedCountry == undefined) {
                errorMessage.style("visibility", "visible");
            } else {
                errorMessage.style("visibility", "hidden");
                const currDivString = "div#step-" + stepNum;
                let currDiv = d3.select(currDivString);
                currDiv.style("display", "none"); // hide current question

                let nextDivString;
                if (stepNum !== 6) {
                    nextDivString = "div#step-" + (stepNum + 1);
                } else {
                    nextDivString = "div#step-1"; // go back to the start of quiz
                }

                let nextDiv = d3.select(nextDivString);
                nextDiv.style("display", "block"); // display next question

                if (stepNum == 1) {
                    findFoodPairing();
                } else if (stepNum == 2) {
                    findWineCountry();
                }
            }
        }
        requestData(); // Load Data
    </script>
</body>

</html>