<html>

<head>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:wght@300;400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <style>
        .main {
            margin: 3em;
        }
        
        .heading {
            padding: 1em;
            background-color: #E2DAD4;
        }
        
        .error-message {
            font-size: 1.1em;
            font-family: 'Roboto Condensed', sans-serif;
            color: #89192D;
            visibility: hidden;
        }
        
        h1 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 400;
        }
        
        h2 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 40;
            color: #89192D;
        }
        
        h3 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 700;
            font-size: 35;
            margin-bottom: 2px;
            color: black;
        }
        
        h4 {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 300;
            font-size: 20;
            margin-top: 2px;
            margin-bottom: 0;
            color: #A5A5A5;
        }
        
        p {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 300;
            font-size: 16;
            color: black;
        }
        
        .gridlines .domain {
            display: none;
        }
        
        .gridlines line {
            stroke: #bbb;
        }
        
        .food,
        .wine {
            padding-top: 10px;
            padding-bottom: 10px;
            border: 2px solid white;
        }
        
        .food:hover,
        .wine:hover {
            border: 2px solid #D17076 !important;
            cursor: pointer;
        }
        
        .btn-main {
            text-align: right;
            margin-right: 5%;
            margin-top: 5px;
        }
        
        .button {
            border: none;
            background-color: #8F8F8F;
            color: white;
            padding-left: 25px;
            padding-right: 25px;
            padding-top: 10px;
            padding-bottom: 10px;
            text-align: center;
            font-family: 'Roboto Condensed', sans-serif;
            font-size: 25px;
            cursor: pointer;
            border-radius: 25px;
            box-shadow: 0px 4px 4px 0px #C1C1C1;
        }
        
        .country {
            fill: lightgrey;
        }
        
        .border {
            stroke: rgb(255, 255, 255);
            stroke-width: 1px;
            fill: none;
        }
        
        .wine-recommendation-card {
            display: inline;
            width: 30%;
            height: 284px;
            border-radius: 20px;
            padding: 20px;
            font-family: 'Roboto Condensed', sans-serif;
        }
        
        .table-data {
            border: none !important;
        }
        
        .wine-recommendation-card-info {
            background-color: lightgrey;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .wine-recommendation-card p {
            margin-top: 0;
        }
        
        .wine-name {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 300;
            font-size: 20;
            color: #A5A5A5;
        }
        
        .wineNameLabel {
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 300;
            font-size: 12;
            color: black;
            margin-top: 15px;
        }
        
        .random-btn {
            background-color: #82A9CF;
            border: none;
            border-radius: 20px;
            padding: 10px 30px 10px 30px;
            padding-left: 30px;
            font-family: 'Roboto Condensed', sans-serif;
            font-weight: 400;
            font-size: 20;
            color: white;
            width: 100%;
            cursor: pointer;
        }
    </style>

</head>

<body>
    <div class="main">
        <div class="heading">
            <h1 style="text-align: center;">Project 3</h1>
            <h2 style="text-align: center;">Find the Perfect Bottle of Wine to Pair with Any Meal!</h2>
        </div>
        <div id="step-1" style="display: block;">
            <h3>01 | What are you eating? </h3>
            <h4>Select a food group below</h4>
            <table style="width: 100%; text-align: center;">
                <tr>
                    <td class="food" id="Vegetables" onclick="selectFood(`Vegetables`)"><img src="/Assets/Vegetables.png" width="120px"><br />
                        <h4>Vegetables</h4>
                    </td>
                    <td class="food" id="SoftCheese" onclick="selectFood(`SoftCheese`)"><img src="/Assets/Soft Cheese.png" width="120px"><br />
                        <h4>Soft Cheese</h4>
                    </td>
                    <td class="food" id="HardCheese" onclick="selectFood(`HardCheese`)"><img src="/Assets/Hard Cheese.png" width="120px"><br />
                        <h4>Hard Cheese</h4>
                    </td>
                    <td class="food" id="Starches" onclick="selectFood(`Starches`)"><img src="/Assets/Starches.png" width="120px"><br />
                        <h4>Starches</h4>
                    </td>
                    <td class="food" id="Fish" onclick="selectFood(`Fish`)"><img src="/Assets/Fish.png" width="120px"><br />
                        <h4>Fish</h4>
                    </td>
                </tr>
                <br />
                <tr>
                    <td class="food" id="Shellfish" onclick="selectFood(`Shellfish`)"><img src="/Assets/Shellfish.png" width="120px"><br />
                        <h4>Shellfish</h4>
                    </td>
                    <td class="food" id="WhiteMeat" onclick="selectFood(`WhiteMeat`)"><img src="/Assets/White Meat.png" width="120px"><br />
                        <h4>White Meat</h4>
                    </td>
                    <td class="food" id="RedMeat" onclick="selectFood(`RedMeat`)"><img src="/Assets/Red Meat.png" width="120px"><br />
                        <h4>Red Meat</h4>
                    </td>
                    <td class="food" id="CuredMeat" onclick="selectFood(`CuredMeat`)"><img src="/Assets/Cured Meat.png" width="120px"><br />
                        <h4>Cured Meat</h4>
                    </td>
                    <td class="food" id="Dessert" onclick="selectFood(`Dessert`)"><img src="/Assets/Dessert.png" width="120px"><br />
                        <h4>Dessert</h4>
                    </td>
                </tr>
            </table>
            <div class="btn-main">
                <p id="error-1" class="error-message">** Please select atleast one food to proceed **</p>
                <button class="button" onclick="clickedButton(1)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-2" style="display: none;">
            <h3>02 | What type of wine do you prefer? </h3>
            <h4 id="step2-label"></h4>
            <br />
            <table style="width: 100%; text-align: center;">
                <tr class="wineBottles">
                </tr>
            </table>
            <div class="btn-main">
                <p id="error-2" class="error-message">** Please select atleast one wine to proceed **</p>
                <button class="button" onclick="clickedButton(2)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-3" style="display: none;">
            <h3>03 | Which country's wine do you prefer? </h3>
            <h4>Select a country below</h4>
            <br />
            <div style="text-align: center;">
                <h4 id="countrySelection"></h4>
                <svg id="world-map" width="1000" height="600" style="border: 1px solid black;"></svg>
            </div>
            <div class="btn-main">
                <p id="error-3" class="error-message">** Please select atleast one country to proceed **</p>
                <button class="button" onclick="clickedButton(3)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-4" style="display: none;">
            <h3>04 | What is your price point? </h3>
            <h4>Drag over your desired price range</h4>
            <br />
            <div style="text-align: center;">
                <h4 id="priceRange"></h4>
                <h4 id="ratingRange"></h4>
                <svg id="chart4" height="500" width="850"></svg>
            </div>
            <div class="btn-main">
                <p id="error-4" class="error-message">** Please indicate a price range to proceed **</p>
                <button class="button" onclick="clickedButton(4)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-5" style="display: none;">
            <h3>05 | Which bottle catches your eye? </h3>
            <h4>Here are your recommendations</h4>
            <br />
            <div style="display: flex;">
                <div style="width: 70%">
                    <div>
                        <table style="width: 100%; text-align: center; table-layout: fixed;">
                            <tr class="wineRecommendation">
                            </tr>
                        </table>
                    </div>
                </div>
                <div class="wine-recommendation-card">
                    <div class="wine-recommendation-card-info" style="text-align: center;">
                        <p id="wine-recom-name" style="font-weight: 500; font-size: 20; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                            HOVER OVER A WINE</p>
                        <table style="width: 100%; text-align: center; table-layout: fixed;">
                            <tr>
                                <td class="table-data" style="text-align: right;">
                                    <p style="padding-right: 10px;"><b>Country:</b></p>
                                </td>
                                <td class="table-data" style="text-align: left;">
                                    <p id="wine-recom-country"></p>
                                </td>
                            </tr>
                            <tr>
                                <td class="table-data" style="text-align: right;">
                                    <p style="padding-right: 10px;"><b>Region:</b></p>
                                </td>
                                <td class="table-data" style="text-align: left;">
                                    <p id="wine-recom-region"></p>
                                </td>
                            </tr>
                            <tr>
                                <td class="table-data" style="text-align: right;">
                                    <p style="padding-right: 10px;"><b>Winery:</b></p>
                                </td>
                                <td class="table-data" style="text-align: left;">
                                    <p id="wine-recom-winery"></p>
                                </td>
                            </tr>
                            <tr>
                                <td class="table-data" style="text-align: right;">
                                    <p style="padding-right: 10px;"><b>Year:</b></p>
                                </td>
                                <td class="table-data" style="text-align: left;">
                                    <p id="wine-recom-year"></p>
                                </td>
                            </tr>
                            <tr>
                                <td class="table-data" style="text-align: right;">
                                    <p style="padding-right: 10px;"><b>Price:</b></p>
                                </td>
                                <td class="table-data" style="text-align: left;">
                                    <p id="wine-recom-price"></p>
                                </td>
                            </tr>
                            <tr>
                                <td class="table-data" style="text-align: right;">
                                    <p style="padding-right: 10px;"><b>Rating:</b></p>
                                </td>
                                <td class="table-data" style="text-align: left;">
                                    <p id="wine-recom-rating"></p>
                                </td>
                            </tr>
                        </table>
                    </div>
                    <button class="random-btn" style="display: none;" id="random-btn" onclick="showRecommendation()"><i class="fa fa-refresh fa-lg"
                        aria-hidden="true" style="padding-right: 10px;"></i>Show Me More</button>
                </div>
            </div>
            <div class="btn-main">
                <p id="error-5" class="error-message">** Please select a bottle to proceed **</p>
                <button class="button" onclick="clickedButton(5)">Next<i class="fa fa-arrow-circle-o-right fa-lg"
                        aria-hidden="true" style="padding-left: 10px;"></i></button>
            </div>
        </div>
        <div id="step-6" style="display: none;">
            <h3>Here's your wine, enjoy!</h3>
            <div class="btn-main">
                <button class="button" onclick="clickedButton(6)">Retake Quiz</button>
            </div>
        </div>
    </div>
    <script>
        // Mapping food names without and with space
        const readableFoodNames = {
            "Vegetables": "Vegetables",
            "SoftCheese": "Soft Cheese",
            "HardCheese": "Hard Cheese",
            "Starches": "Starches",
            "Fish": "Fish",
            "Shellfish": "Shellfish",
            "WhiteMeat": "White Meat",
            "RedMeat": "Red Meat",
            "CuredMeat": "Cured Meat",
            "Dessert": "Dessert"
        }

        // Pairing of foods and wines
        const foodGroups = {
            "Vegetables": ["Red", "Rose", "White", "Sparkling"],
            "SoftCheese": ["Rose", "White", "Sparkling"],
            "HardCheese": ["Red", "White", "Sparkling"],
            "Starches": ["Red", "Rose", "White", "Sparkling"],
            "Fish": ["White", "Sparkling"],
            "Shellfish": ["Red", "Rose", "White"],
            "WhiteMeat": ["Red", "White"],
            "RedMeat": ["Red"],
            "CuredMeat": ["Red", "White"],
            "Dessert": ["White"]
        }

        var redCountriesTop10;
        var whiteCountriesTop10;
        var roseCountriesTop10;
        var sparklingCountriesTop10;


        // Step 4 Price Chart setup
        const svg = d3.select("svg#chart4");
        const width = svg.attr("width");
        const height = svg.attr("height");
        const margin = {
            top: 10,
            right: 10,
            bottom: 60,
            left: 65
        };
        const chartWidth = width - margin.left - margin.right;
        const chartHeight = height - margin.top - margin.bottom;

        let annotations = svg.append("g").attr("id", "annotations");
        let chartArea = svg.append("g").attr("id", "points")
            .attr("transform", `translate(${margin.left},${margin.top})`);
        let brushArea = svg.append("g").attr("id", "brush")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        let redWines, whiteWines, roseWines, sparklingWines;

        const requestData = async function() {
            redWines = await d3.csv("Red.csv", d3.autoType);
            whiteWines = await d3.csv("White.csv", d3.autoType);
            roseWines = await d3.csv("Rose.csv", d3.autoType);
            sparklingWines = await d3.csv("Sparkling.csv", d3.autoType);

            /* DATA PROCESSING:
             * For each wine category: Count the number of rows for a country
             * Keep only the data that belongs to one of the top 10 countries
             * 
             * Change price from EUR to USD
             */

            // ===== DATA PROCESSING FOR RED WINES =====
            redCountryCount = {};
            // counting number of wines from each country
            redWines.forEach(item => {
                if (item['Country'] in redCountryCount) {
                    redCountryCount[item['Country']] += 1;
                } else {
                    redCountryCount[item['Country']] = 1;
                }
            });
            let redCountries = Object.entries(redCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (redCountries.length > 10) {
                redCountries.splice(10); // keeping only the top 10 countries
            }

            // save the top 10 countries with the count for red wine
            redCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                redCountriesTop10.set(redCountries[i], redCountryCount[redCountries[i]]);
            }
            // delete entries from other countries
            redWines.forEach((item, index) => {
                if (!redCountries.includes(item["Country"])) {
                    redWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });

            // ===== DATA PROCESSING FOR WHITE WINES =====
            whiteCountryCount = {};
            // counting number of wines from each country
            whiteWines.forEach(item => {
                if (item['Country'] in whiteCountryCount) {
                    whiteCountryCount[item['Country']] += 1;
                } else {
                    whiteCountryCount[item['Country']] = 1;
                }
            });
            let whiteCountries = Object.entries(whiteCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (whiteCountries.length > 10) {
                whiteCountries.splice(10); // keeping only the top 10 countries
            }
            // save the top 10 countries with the count for white wine
            whiteCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                whiteCountriesTop10.set(whiteCountries[i], whiteCountryCount[whiteCountries[i]]);
            }

            // delete entries from other countries
            whiteWines.forEach((item, index) => {
                if (!whiteCountries.includes(item["Country"])) {
                    whiteWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });

            // ===== DATA PROCESSING FOR ROSE WINES =====
            roseCountryCount = {};
            // counting number of wines from each country
            roseWines.forEach(item => {
                if (item['Country'] in roseCountryCount) {
                    roseCountryCount[item['Country']] += 1;
                } else {
                    roseCountryCount[item['Country']] = 1;
                }
            });
            let roseCountries = Object.entries(roseCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (roseCountries.length > 10) {
                roseCountries.splice(10); // keeping only the top 10 countries
            }
            // save the top 10 countries with the count for rose wine
            roseCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                roseCountriesTop10.set(roseCountries[i], roseCountryCount[roseCountries[i]]);
            }
            // delete entries from other countries
            roseWines.forEach((item, index) => {
                if (!roseCountries.includes(item["Country"])) {
                    roseWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });

            // ===== DATA PROCESSING FOR SPARKLING WINES =====
            sparklingCountryCount = {};
            // counting number of wines from each country
            sparklingWines.forEach(item => {
                if (item['Country'] in sparklingCountryCount) {
                    sparklingCountryCount[item['Country']] += 1;
                } else {
                    sparklingCountryCount[item['Country']] = 1;
                }
            });
            let sparklingCountries = Object.entries(sparklingCountryCount).sort((a, b) => b[1] - a[1]).map(el => el[0]); // sorting by the country count and returning only the country names
            if (sparklingCountries.length > 10) {
                sparklingCountries.splice(10); // keeping only the top 10 countries
            }
            // save the top 10 countries with the count for sparkling wine
            sparklingCountriesTop10 = new Map();
            for (let i = 0; i < 10; i++) {
                sparklingCountriesTop10.set(sparklingCountries[i], sparklingCountryCount[sparklingCountries[i]]);
            }

            // delete entries from other countries
            sparklingWines.forEach((item, index) => {
                if (!sparklingCountries.includes(item["Country"])) {
                    sparklingWines.splice(index, 1);
                } else {
                    item["Price"] *= 1.13; // change price from EUR to USD
                }
            });
        };
        requestData(); // Load Data

        // --- TRACKING USER SELECTIONS ---
        let selectedFoodItem;
        let selectedWine;
        let selectedCountry;
        let selectedPriceRange;
        let chosenDataSet;
        let startPrice, endPrice, startRating, endRating;
        let finalWineChoice;

        // Step 1: Selecting food item
        function selectFood(foodItem) {
            let allFoods = d3.selectAll("td");
            allFoods.style("border", "2px solid white");
            const currSelection = "td#" + foodItem;
            let currFoodItem = d3.select(currSelection);
            currFoodItem.style("border", "2px solid black");
            selectedFoodItem = foodItem;
        }

        // Step 1 to Step 2 filtering
        function findFoodPairing() {
            let label = d3.select("#step2-label");
            const availableWines = foodGroups[selectedFoodItem];
            let textString = "";
            let tableRow = d3.select(".wineBottles");
            for (let i = 0; i < availableWines.length; i++) {
                // Displaying the correct wines
                let wine = tableRow.append("td")
                    .attr("class", "wine")
                    .attr("id", availableWines[i]);
                let currImgLocation = "/Assets/" + availableWines[i] + ".png";
                wine.append("img") // Wine images
                    .attr("height", 300)
                    .attr("src", currImgLocation);
                wine.on("click", function() { // Interactivity on selecting wine
                    let allWines = d3.selectAll("td");
                    allWines.style("border", "2px solid white"); // Unselect other selections
                    const currSelection = "td#" + availableWines[i];
                    let currWine = d3.select(currSelection);
                    currWine.style("border", "2px solid black");
                    selectedWine = availableWines[i];
                });

                // Setting the description header text
                textString = textString + availableWines[i];
                if (i != availableWines.length - 1) {
                    textString = textString + ","; // add comma after all but the last name
                }
                textString = textString + " ";
            }
            textString = textString + "wine(s) pair best with " + readableFoodNames[selectedFoodItem];
            if (availableWines.length > 1) {
                textString = textString + ". Pick One!";
            } else {
                textString = textString + ". Please select it to proceed!";
            }
            label.text(textString);
        }

        // Step 2 to Step 3 filtering
        function findWineCountry() {
            let top10Countries;
            if (selectedWine == "Red") {
                top10Countries = redCountriesTop10;
                chosenDataSet = redWines;
            } else if (selectedWine == "Rose") {
                top10Countries = roseCountriesTop10;
                chosenDataSet = roseWines;
            } else if (selectedWine == "White") {
                top10Countries = whiteCountriesTop10;
                chosenDataSet = whiteWines;
            } else if (selectedWine == "Sparkling") {
                top10Countries = sparklingCountriesTop10;
                chosenDataSet = sparklingWines;
            }
            drawMapChart(top10Countries);
        }

        // Draw the map - Step 3
        const drawMapChart = async function(top10Countries) {
            let worldMap = d3.select('#world-map');
            let width = worldMap.attr('width');
            let height = worldMap.attr('height');
            let padding = {
                top: 20,
                right: 20,
                bottom: 20,
                left: 20
            };
            let mapWidth = width - padding.left - padding.right;
            let mapHeight = height - padding.top - padding.bottom;
            // color scale
            let colorScale = d3.scaleQuantile()
                .domain([0, 2650])
                .range(['#44A8DE', '#3260AF', '#22297F', '#1F134D']);

            // map data
            let world = await d3.json('geography.json');
            let countries = topojson.feature(world, world.objects.countries);
            let countriesMesh = topojson.mesh(world, world.objects.countries);
            let projection = d3.geoEquirectangular().fitSize([mapWidth, mapHeight], countries);
            let path = d3.geoPath().projection(projection);

            // draw map
            let map = worldMap.append("g")
                .attr('transform', `translate(${padding.left}, ${padding.top})`);

            let countryLabel = d3.select("#countrySelection");
            countryLabel.style("color", "black");
            countryLabel.text(`Selected Country: --`);

            let trimmedDataSet = [];
            map.selectAll('path.state')
                .data(countries.features)
                .join('path')
                .attr('class', 'country')
                .attr('id', d => d.properties.name)
                .attr('d', path)
                .style('fill', d => {
                    if (top10Countries.has(d.properties.name)) {
                        return colorScale(top10Countries.get(d.properties.name));
                    } else {
                        return "lightgrey";
                    }
                })
                .on("click", function() {
                    let country = d3.select(this).datum().properties.name;
                    if (top10Countries.has(country)) {
                        selectedCountry = country;
                        countryLabel.text(`Selected Country: ${selectedCountry}`);
                        chosenDataSet.forEach((item, index) => {
                            if (item['Country'] == selectedCountry) {
                                trimmedDataSet.push(item);
                            };
                        });
                        chosenDataSet = trimmedDataSet;
                    }
                });

            map.append('path')
                .datum(countriesMesh)
                .attr('class', 'border')
                .attr('d', path);
        };

        // Step 4 price graphs
        function priceGraph() {
            let dataFillColour;
            if (selectedWine == "Red") {
                dataFillColour = "#db3d13";
            } else if (selectedWine == "Rose") {
                dataFillColour = "#f38989";
            } else if (selectedWine == "White") {
                dataFillColour = "#ccccff";
            } else if (selectedWine == "Sparkling") {
                dataFillColour = "#ffcb12";
            }

            // Creating Scales
            const priceExtent = d3.extent(chosenDataSet, d => d['Price']);
            const priceScale = d3.scaleLog().domain(priceExtent).range([0, chartWidth]);

            const ratingExtent = d3.extent(chosenDataSet, d => d['Rating']);
            const ratingScale = d3.scaleLinear().domain(ratingExtent).range([chartHeight, 0]);

            // Brush
            let brush = d3.brush().extent([
                [-10, 0],
                [chartWidth + 10, chartHeight + 10]
            ]).on("start brush end", brushed);

            // X axis
            let bottomAxis = d3.axisBottom(priceScale);
            let bottomGridlines = d3.axisBottom(priceScale)
                .tickSize(-chartHeight - 10)
                .tickFormat("")
            annotations.append("g")
                .attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
                .call(bottomAxis);
            annotations.append("g")
                .attr("class", "x gridlines")
                .attr("transform", `translate(${margin.left},${chartHeight + margin.top + 10})`)
                .call(bottomGridlines);

            svg.append("text") // Axis label
                .attr("class", "x label")
                .attr("text-anchor", "middle")
                .attr("x", margin.left + (chartWidth / 2))
                .attr("y", chartHeight + margin.top + 50)
                .style("font-size", 14)
                .style("font-family", 'Roboto Condensed')
                .text(`Price of ${selectedWine} Wines (USD)`);

            // Y axis
            let leftAxis = d3.axisLeft(ratingScale)
            let leftGridlines = d3.axisLeft(ratingScale)
                .tickSize(-chartWidth - 10)
                .tickFormat("")
            annotations.append("g")
                .attr("class", "y axis")
                .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                .call(leftAxis)
            annotations.append("g")
                .attr("class", "y gridlines")
                .attr("transform", `translate(${margin.left - 10},${margin.top})`)
                .call(leftGridlines);

            svg.append("text") // Axis label
                .attr("class", "y label")
                .attr("text-anchor", "middle")
                .attr("x", -margin.top - (chartHeight / 2))
                .attr("y", margin.left / 2 - 10)
                .attr('transform', "rotate(-90)")
                .style("font-size", 14)
                .style("font-family", 'Roboto Condensed')
                .text("Rating of Wine");

            // Adding Points to Graph
            const dot = chartArea.selectAll("circle.wine").data(chosenDataSet)
                .join("circle")
                .attr("class", "wine")
                .attr("cx", d => priceScale(d['Price']))
                .attr("cy", d => ratingScale(d['Rating']))
                .attr("r", 5)
                .attr("opacity", 0.6)
                .attr("fill", dataFillColour);

            brushArea.call(brush);

            let priceLabel = d3.select("#priceRange");
            priceLabel.style("color", "black");
            priceLabel.text(`Selected Price Range: $-- to $--`);
            let ratingLabel = d3.select("#ratingRange");
            ratingLabel.style("color", "black");
            ratingLabel.text(`Selected Rating Range: -- to --`);

            // Brush function on graph
            function brushed(event) {
                if (event.selection !== null) {
                    startPrice = priceScale.invert(event.selection[0][0]);
                    endRating = ratingScale.invert(event.selection[0][1]);
                    endPrice = priceScale.invert(event.selection[1][0]);
                    startRating = ratingScale.invert(event.selection[1][1]);

                    if (startPrice !== endPrice && startRating !== endRating) {
                        // user has made a proper selection
                        selectedPriceRange = true;
                        priceLabel.text(`Selected Price Range: $${Math.round(startPrice * 100) / 100} to $${Math.round(endPrice * 100) / 100}`);
                        ratingLabel.text(`Selected Rating Range: ${Math.round(startRating * 100) / 100} to ${Math.round(endRating * 100) / 100}`);
                    } else {
                        // user has clicked out of selection
                        selectedPriceRange = false;
                        priceLabel.text(`Selected Price Range: $-- to $--`);
                        ratingLabel.text(`Selected Rating Range: -- to --`);
                    }
                }
            }
        }

        // Step 4 to 5 transition
        function filterBasedOnPrice() {
            let priceFilteredData = [];
            chosenDataSet.forEach((item, index) => {
                // filter based on price and rating selected
                if (item["Price"] >= startPrice && item["Price"] <= endPrice && item["Rating"] >= startRating && item["Rating"] <= endRating) {
                    priceFilteredData.push(item);
                }
            });
            chosenDataSet = priceFilteredData;
        }

        // Step 5 - Show recommendations
        function showRecommendation() {
            finalWineChoice = undefined; // reinitialize the final choice

            let randomNumbers = [];
            if (chosenDataSet.length > 4) {
                let randomNumberSet = get4RandomNumbers(chosenDataSet.length);
                randomNumbers = Array.from(randomNumberSet);
                d3.select(".random-btn").style("display", "block"); // display the generate random button
            } else {
                for (let i = 0; i < chosenDataSet.length; i++) {
                    randomNumbers.push(i); // display only the wines in the set (not random ones)
                }
            }

            let tableRow = d3.select(".wineRecommendation").html("");
            for (let i = 0; i < randomNumbers.length; i++) {
                let wineInfo = chosenDataSet[randomNumbers[i]];
                // Displaying the correct wines
                let wine = tableRow
                    .append("td")
                    .attr("class", "wine");
                let currImgLocation = "/Assets/" + selectedWine + ".png";
                wine.append("img") // Wine images
                    .attr("height", 300)
                    .attr("src", currImgLocation);
                let wineLabel = wine.append("div").attr("class", "wineNameLabel");
                wineLabel.append("text")
                    .text(wineInfo.Name); // Wine label

                let wineRcomName = d3.select("#wine-recom-name");
                let wineRcomCountry = d3.select("#wine-recom-country");
                let wineRcomYear = d3.select("#wine-recom-year");
                let wineRcomPrice = d3.select("#wine-recom-price");
                let wineRcomRating = d3.select("#wine-recom-rating");
                let wineRcomRegion = d3.select("#wine-recom-region");
                let wineRcomWinery = d3.select("#wine-recom-winery");

                wine.on("mouseover", function() {
                    wineRcomName.text(wineInfo.Name);
                    wineRcomCountry.text(wineInfo.Country);
                    wineRcomRegion.text(wineInfo.Region);
                    wineRcomWinery.text(wineInfo.Winery);
                    wineRcomYear.text(wineInfo.Year);
                    wineRcomPrice.text(wineInfo.Price.toFixed(2) + " USD");
                    wineRcomRating.text(wineInfo.Rating);
                });

                wine.on("mouseout", function() {
                    wineRcomName.text("HOVER OVER A WINE");
                    wineRcomCountry.text("");
                    wineRcomRegion.text("");
                    wineRcomWinery.text("");
                    wineRcomYear.text("");
                    wineRcomPrice.text("");
                    wineRcomRating.text("");
                });

                wine.on("click", function() {
                    let allWines = d3.selectAll(".wine");
                    allWines.style("border", "2px solid white"); // Unselect other selections
                    wine.style("border", "2px solid black");
                    finalWineChoice = wineInfo;
                    console.log("final-choice", finalWineChoice);

                    wineRcomName.text(wineInfo.Name);
                    wineRcomCountry.text(wineInfo.Country);
                    wineRcomRegion.text(wineInfo.Region);
                    wineRcomWinery.text(wineInfo.Winery);
                    wineRcomYear.text(wineInfo.Year);
                    wineRcomPrice.text(wineInfo.Price.toFixed(2) + " USD");
                    wineRcomRating.text(wineInfo.Rating);
                });
            }
        }

        function get4RandomNumbers(N) {
            let randNumbers = new Set();
            while (randNumbers.size < 4 && randNumbers.size < N) {
                randNumbers.add(Math.floor(Math.random() * N));
            }
            return randNumbers;
        }

        // Button transition from one question to the next
        function clickedButton(stepNum) {
            // Error conditions for moving to "next"
            const errorString = "#error-" + stepNum;
            let errorMessage = d3.select(errorString);
            if (stepNum == 1 && selectedFoodItem == undefined) {
                errorMessage.style("visibility", "visible");
            } else if (stepNum == 2 && selectedWine == undefined) {
                errorMessage.style("visibility", "visible");
            } else if (stepNum == 3 && selectedCountry == undefined) {
                errorMessage.style("visibility", "visible");
            } else if (stepNum == 4 && (selectedPriceRange == undefined || selectedPriceRange == false)) {
                errorMessage.style("visibility", "visible");
            } else if (stepNum == 5 && finalWineChoice == undefined) {
                errorMessage.style("visibility", "visible");
            } else {
                errorMessage.style("visibility", "hidden");
                const currDivString = "div#step-" + stepNum;
                let currDiv = d3.select(currDivString);
                currDiv.style("display", "none"); // hide current question

                let nextDivString;
                if (stepNum !== 6) {
                    nextDivString = "div#step-" + (stepNum + 1);
                } else {
                    location.reload(); // go back to the start of quiz and reset all properties
                }

                let nextDiv = d3.select(nextDivString);
                nextDiv.style("display", "block"); // display next question

                // Functions to call on transtion from one step to the next
                if (stepNum == 1) {
                    findFoodPairing();
                } else if (stepNum == 2) {
                    findWineCountry();
                } else if (stepNum == 3) {
                    priceGraph();
                } else if (stepNum == 4) {
                    filterBasedOnPrice();
                    showRecommendation();
                }
            }
        }
    </script>
</body>

</html>